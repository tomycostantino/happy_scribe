<%= turbo_frame_tag "meeting_participants" do %>
  <%= card class: "px-6 py-4" do %>
    <div class="flex items-center justify-between mb-3">
      <%= section_header("Participants") %>
      <span class="text-xs text-gray-400"><%= meeting.participants.count %></span>
    </div>

    <% if meeting.participants.any? %>
      <div class="space-y-3 mb-4">
        <% speakers = meeting.transcript&.transcript_segments&.select(:speaker)&.distinct&.pluck(:speaker)&.compact || [] %>
        <% meeting.participants.includes(:contact).each do |participant| %>
          <div class="flex items-start gap-3">
            <div class="h-7 w-7 rounded-full bg-indigo-50 flex items-center justify-center shrink-0 mt-0.5">
              <span class="text-xs font-semibold text-indigo-600"><%= participant.contact.name.first(1).upcase %></span>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between gap-2">
                <p class="text-sm font-medium text-gray-900 truncate"><%= participant.contact.name %></p>
                <%= button_to meeting_participant_path(meeting, participant), method: :delete,
                      class: "text-gray-300 hover:text-red-500 transition-colors cursor-pointer shrink-0",
                      data: { turbo_confirm: "Remove this participant?", turbo_frame: "meeting_participants" } do %>
                  <%= close_icon(css_class: "h-3.5 w-3.5") %>
                <% end %>
              </div>
              <p class="text-xs text-gray-400 truncate"><%= participant.contact.email %></p>
              <% if speakers.any? %>
                <%= form_with model: participant, url: meeting_participant_path(meeting, participant), method: :patch,
                      data: { turbo_frame: "meeting_participants" }, class: "mt-1" do |f| %>
                  <%= f.select :speaker_label,
                        options_for_select(
                          [["Assign speaker...", ""]] + speakers.map { |s| [s, s] },
                          participant.speaker_label
                        ),
                        {},
                        class: "w-full rounded border-0 py-0.5 pl-2 pr-6 text-xs text-gray-500 ring-1 ring-inset ring-gray-200 focus:ring-2 focus:ring-indigo-600 bg-gray-50",
                        onchange: "this.form.requestSubmit()" %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# Add participant form %>
    <% available_contacts = meeting.user.contacts.where.not(id: meeting.contact_ids).order(:name) %>
    <% if available_contacts.any? %>
      <%= form_with url: meeting_participants_path(meeting), method: :post,
            data: { turbo_frame: "meeting_participants" }, class: "flex items-center gap-2" do |f| %>
        <%= f.select :contact_id,
              options_for_select(available_contacts.map { |c| [c.name, c.id] }),
              { prompt: "Add contact..." },
              class: "flex-1 rounded border-0 py-1.5 pl-3 pr-8 text-sm text-gray-900 ring-1 ring-inset ring-gray-200 focus:ring-2 focus:ring-inset focus:ring-indigo-600",
              name: "meeting_participant[contact_id]" %>
        <%= f.submit "Add",
              class: "rounded bg-indigo-600 py-1.5 px-3 text-sm font-semibold text-white hover:bg-indigo-500 cursor-pointer" %>
      <% end %>
    <% elsif meeting.user.contacts.none? %>
      <p class="text-sm text-gray-500 text-center py-2">
        <%= link_to "Create a contact", new_contact_path, class: "text-indigo-600 hover:text-indigo-500 font-medium" %> to add participants.
      </p>
    <% else %>
      <p class="text-xs text-gray-400 text-center">All contacts added.</p>
    <% end %>
  <% end %>
<% end %>
